<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Project Zomboid Mod Manager</title>
<style>
body {
    font-family: "Figtree", sans-serif;
    background: #080c14;
    color: #e5e7eb;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    margin: 0;
}


.card_topbar {
    position: sticky;
    top: 20px;
    z-index: 800;
    display: block;
    background: #1b263d;
    align-items: center;
    display: flex;
    padding-block: 15px;
    padding-inline: 30px;
    margin: 50px;
    gap: 20px;
    width: 600px;
    max-width: 100%;
    border-radius: 24px;
    outline: #344466;
    outline-style:groove;
    outline-width: 2px;
    border-radius: 20px;
    box-shadow: 0px 0px 24px rgba(0, 0, 0, 1);
}

.card_collectionbar {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 999;
    display:flex;
    background: #1b263d;
    align-items: center;
    display: flex;
    padding-block: 15px;
    padding-inline: 30px;
    gap: 20px;
    width: 600px;
    max-width: 100%;
    border-radius: 24px;
    outline: #344466;
    outline-style:groove;
    outline-width: 2px;
    border-radius: 20px;
    box-shadow: 0px 0px 24px rgba(0, 0, 0, 1);
}

.card_blackbackground {
    position: fixed;
    z-index: 998;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.8);
    margin: 0;
    padding: 0;
    pointer-events: all;
}

.txt_workshop {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    
}

.btn_main {
    padding: 10px 16px;
    margin-left: 12px;
    border: none;
    background: #3a880d;
    color: white;
    cursor: pointer;
    font-weight: 600;
    border-radius: 12px;
    outline: solid #276106;
    outline-style:groove;
    outline-width: 2px;
    box-shadow: 0px 8px 24px rgba(0, 0, 0, 0.4);
}

.btn_main:hover {
    background: #68b839;
}

.btn_main:active {
    background: #276106
}






.card_modlist {
    display: block;
    background: #0f1524;
    margin-bottom: 10px;
    padding: 20px;
    gap: 20px;
    border-radius: 24px;
    width: calc(100% - 200px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, .4);
}

.card_modlistcontent{
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 300px));
    justify-content: center; 
}

.card_modcard {
    display: flex;
    position: relative;
    flex-direction: column;
    justify-content:baseline;
    background: #1b263d;

    padding: 15px;
    margin-block: 20px;
    margin-inline: 10px;

    width: 240;
    min-width: 240px;
    max-width: 100%;

    height: 500px;
    min-height: 450px;
    max-height: 100%;


    outline: #344466;
    outline-style:groove;
    outline-width: 2px;
    border-radius: 20px;
    box-shadow: 0px 8px 24px rgba(0, 0, 0, 0.8);
}

.img_modcard {
    display: block;
    margin-inline: auto;
    width: 80%;
    outline: solid;
    outline-style:groove;
    outline-width: 2px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, .4);

}

.lbl_modcard-title {
    margin-block: 15px;
    font-size: 20px;
    font-weight: bold;
    text-align: center;
}

.lbl_modcard-element {
    font-size: 15px;
    margin-block: 0px;
}

.card_modcard_buttons {
    margin-inline: auto;
    display:flex;
    align-self: auto;
    align-items: center;
    margin-top: 12px;
}

.btn_edittags {
    position: absolute;
    top: 10px; 
    right: 10px; 
    margin-inline: 0px;
    width: 20px;
    height: 20px;
    border: none;
    background: #1b263d;
    color: white;
    cursor: pointer;
    border-radius: 8px;
    outline: solid #344466;
    outline-style:groove;
    outline-width: 2px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, .4);
}


.btn_edittags:hover {
    background: #344466;;
}

.btn_edittags:active {
    background: #0f1524;
}

.btn_modcard {
    padding: 5px;
    margin-inline: 5px;
    border: none;
    background: #3a880d;
    color: white;
    cursor: pointer;
    border-radius: 12px;
    outline: solid #276106;
    outline-style:groove;
    outline-width: 2px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, .4);
}


.btn_modcard:hover {
    background: #68b839;
}

.btn_modcard:active {
    background: #276106;
}


.card_modcard-cbx {
    flex-grow: 1;
    overflow-y: auto;
        scrollbar-color: #344466 #1b263d;
    scrollbar-width: 5px;
}
    

.cbx input{
    display: none;
}

.cbx label::before{
    content: "O";
    text-align: center;
    display: inline-block;
    margin-block: 2px;
    width: 16px;
    height: 16px;
    margin-right: 5px;
    color: #ffffff00;
    background-color: #0f1524;
    border: 2px solid #276106;
    border-radius: 8px; 
}

.cbx input:checked + label:before {
    background-color: #3a880d;
    border: 2px solid #ffffff;

}


.card_modlist_buttons{
    margin-inline: auto;
    display:flex;
    margin-top: 40px;
    justify-content:end;
    align-items: center;

}



.card_tagseditor {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index:999;
    display: flex;
    flex-direction: column;

    justify-content:baseline;
    background: #1b263d;

    padding-inline: 10px;
    padding-bottom: 15px;
    margin-block: 10px;
    margin-inline: 10px;

    width: 240;
    min-width: 600px;
    max-width: 100%;

    height: 500px;
    min-height: 450px;
    max-height: 100%;


    outline: #344466;
    outline-style:groove;
    outline-width: 2px;
    border-radius: 20px;
    box-shadow: 0px 8px 24px rgba(0, 0, 0, 0.8);
}

.lbl_edittags-title {
    margin-bottom: 10px;
    font-size: 25px;
    font-weight: bold;
    text-align: center;
}

.card_tagseditor_content {
    padding-inline: 5px;
    flex-grow: 1;
    overflow-y: auto;
    scrollbar-color: #344466 #1b263d;
    scrollbar-width: 5px;
}

.card_tagseditor_buttons{
    margin-inline: auto;
    display:flex;
    margin-top: 20px;
    justify-content:end;
    align-items: center;
}

.txt_tagseditor {
    flex: 1;
    padding: 8px;
    margin-block: 4px;
    border: none;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    
}

.dropdown {
    padding: 8px;
    margin-block: 4px;
    background: #0f1524;
    cursor: pointer;
    color: white;
    outline: solid #344466;
    outline-style:groove;
    outline-width: 2px;
    border: none;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
}


:root{
    --color01: rgba(19, 46, 3, 0.8);
    --color02: rgb(104, 184, 57);
}

.card_status {
    position: fixed;
    bottom: 25px;
    left: 25px;
    z-index:1000;
    padding-bottom: 25px;
    padding-inline: 20px;
    display: flex;
    flex-direction: column;
    justify-content:baseline;
    background: var(--color01);
    height: 30px;
    color: var(--color02);
    outline: var(--color02);
    outline-style:groove;
    outline-width: 2px;
    border-radius: 20px;
    box-shadow: 0px 8px 24px rgba(0, 0, 0, 0.8);
    user-select: none;
    pointer-events: none; 
    opacity: 0;
}
@keyframes status-in {
    from { transform: translateX(-20px);}
    to { transform: translateX(0); }
}

@keyframes status-out {
    from { opacity: 1; transform: translateX(0); }
    to { opacity: 0; transform: translateX(-30px); }
}

.card_status.status-visible {
    animation: status-in 0.5s cubic-bezier(.4,2,.6,1) forwards;
    opacity: 1;
    transform: translateX(0);
}

.card_status.status-hide {
    animation: status-out 0.5s cubic-bezier(.4,2,.6,1) forwards;
}
</style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <svg id="svgicon" style="display: none;" xmlns="http://www.w3.org/2000/svg"><symbol id="ico_left" viewBox="0 0 24 24"><path fill="#FFFFFF" d="m9.55 12l7.35 7.35q.375.375.363.875t-.388.875q-.375.375-.875.375t-.875-.375l-7.7-7.675q-.3-.3-.45-.675t-.15-.75q0-.375.15-.75t.45-.675l7.7-7.7q.375-.375.888-.363t.887.388q.375.375.375.875t-.375.875L9.55 12Z"/></symbol></svg>
    <svg id="svgicon" style="display: none;" xmlns="http://www.w3.org/2000/svg"><symbol id="ico_steam" viewBox="0 0 496 512"><path fill="#FFFFFF" d="M496 256c0 137-111.2 248-248.4 248c-113.8 0-209.6-76.3-239-180.4l95.2 39.3c6.4 32.1 34.9 56.4 68.9 56.4c39.2 0 71.9-32.4 70.2-73.5l84.5-60.2c52.1 1.3 95.8-40.9 95.8-93.5c0-51.6-42-93.5-93.7-93.5s-93.7 42-93.7 93.5v1.2L176.6 279c-15.5-.9-30.7 3.4-43.5 12.1L0 236.1C10.2 108.4 117.1 8 247.6 8C384.8 8 496 119 496 256zM155.7 384.3l-30.5-12.6a52.79 52.79 0 0 0 27.2 25.8c26.9 11.2 57.8-1.6 69-28.4c5.4-13 5.5-27.3.1-40.3c-5.4-13-15.5-23.2-28.5-28.6c-12.9-5.4-26.7-5.2-38.9-.6l31.5 13c19.8 8.2 29.2 30.9 20.9 50.7c-8.3 19.9-31 29.2-50.8 21zm173.8-129.9c-34.4 0-62.4-28-62.4-62.3s28-62.3 62.4-62.3s62.4 28 62.4 62.3s-27.9 62.3-62.4 62.3zm.1-15.6c25.9 0 46.9-21 46.9-46.8c0-25.9-21-46.8-46.9-46.8s-46.9 21-46.9 46.8c.1 25.8 21.1 46.8 46.9 46.8z"/></symbol></svg>
    <svg id="svgicon" style="display: none;" xmlns="http://www.w3.org/2000/svg"><symbol id="ico_delete" viewBox="0 0 24 24"><path fill="#FFFFFF" d="M2.75 6.167c0-.46.345-.834.771-.834h2.665c.529-.015.996-.378 1.176-.916l.03-.095l.115-.372c.07-.228.131-.427.217-.605c.338-.702.964-1.189 1.687-1.314c.184-.031.377-.031.6-.031h3.478c.223 0 .417 0 .6.031c.723.125 1.35.612 1.687 1.314c.086.178.147.377.217.605l.115.372l.03.095c.18.538.74.902 1.27.916h2.57c.427 0 .772.373.772.834c0 .46-.345.833-.771.833H3.52c-.426 0-.771-.373-.771-.833ZM11.607 22h.787c2.707 0 4.06 0 4.941-.863c.88-.864.97-2.28 1.15-5.111l.26-4.081c.098-1.537.147-2.305-.295-2.792c-.442-.487-1.187-.487-2.679-.487H8.23c-1.491 0-2.237 0-2.679.487c-.441.487-.392 1.255-.295 2.792l.26 4.08c.18 2.833.27 4.248 1.15 5.112C7.545 22 8.9 22 11.607 22Z"/></svg>
    <svg id="svgicon" style="display: none;" xmlns="http://www.w3.org/2000/svg"><symbol id="ico_right" viewBox="0 0 24 24"><path fill="#FFFFFF" d="m14.475 12l-7.35-7.35q-.375-.375-.363-.888t.388-.887q.375-.375.888-.375t.887.375l7.675 7.7q.3.3.45.675t.15.75q0 .375-.15.75t-.45.675l-7.7 7.7q-.375.375-.875.363T7.15 21.1q-.375-.375-.375-.888t.375-.887L14.475 12Z"/></symbol></svg>
    <svg id="svgicon" style="display: none;" xmlns="http://www.w3.org/2000/svg"><symbol id="ico_next" viewBox="0 0 24 24"><path fill="#FFFFFF" d="M4 6h2v12H4zm4 7h8.586l-4.293 4.293l1.414 1.414L20.414 12l-6.707-6.707l-1.414 1.414L16.586 11H8z"/></symbol></svg>
</head>
<body>

    <div id="status" class="card_status">
        <p id="statustext" class="lbl_status">asdasddas</p>
    </div>

    <div id="overlay_Collection" hidden>
        <div class="card_blackbackground"></div>
        <div class="card_collectionbar">
            <input class="txt_workshop" id="collectionId" type="text" placeholder="Ej: 3378994227" />
            <button class="btn_main" onclick="importCollection()">Import Collection</button>
        </div>
    </div>

    <div id="overlay_TagEditor" hidden>
    <div class="card_blackbackground"></div>
    <div class="card_tagseditor">
        <p class="lbl_edittags-title" >Edit tags</p>
        <div class="card_tagseditor_content" id="tagEditorList"></div>
        <div class="card_tagseditor_buttons">
            <button class="btn_main" id="addTagBtn">Add Tag</button>
            <button class="btn_main" id="doneTagEditBtn">Done</button>
            <button class="btn_main" id="cancelTagEditBtn" onclick="document.getElementById('overlay_TagEditor').hidden = true;">Cancel</button>
        </div>    
    </div>
</div>


    <img src="https://github.com/BasaraBasarin/Project-Zomboid-Mod-Manager/blob/main/PZMM.png?raw=true" width="300px" style="margin-top: 20px;">

    <div class="card_topbar">
        <input class="txt_workshop" id="workshopId" type="text" placeholder="Ej: 3378994227" />
        <button class="btn_main" onclick="addMod()">Add mod</button>
    </div>
    
 
    <div class="card_modlist">
        <div class="card_modlistcontent" id="modlistcontent"></div>
        <div class="card_modlist_buttons">
            <button class="btn_main" onclick="importJson()">Import JSON</button>
            <button class="btn_main" onclick="exportJson()">Export JSON</button>
            <button class="btn_main" onclick="document.getElementById('overlay_Collection').hidden = false">Import Collection</button>
            <button class="btn_main" onclick="clearAll(true)">Clear All</button>
            <button class="btn_main" onclick="copyWorkshopID()">Copy Workshop ID's</button>
            <button class="btn_main" onclick="copyModID()">Copy Mod ID's</button>
            <button class="btn_main" onclick="copyMapID()">Copy Map ID's</button>
        </div> 
    </div>

    

<script>
MLjson = [];
let currentEditIndex = null;
let tempTags = [];
let statusTimeout;


function setStatus(msg, type) {
    var r = document.querySelector(':root');
    if (type == 'a') {
        r.style.setProperty('--color01', 'rgba(15, 35, 3, 0.9)');
        r.style.setProperty('--color02', 'rgb(104, 184, 57)');
    } else if (type == 'b') {
        r.style.setProperty('--color01', 'rgba(32, 2, 2, 0.9)');
        r.style.setProperty('--color02', 'rgba(179, 28, 28, 1)');
    } else if (type == 'c') {
        r.style.setProperty('--color01', 'rgba(33, 32, 36, 0.9)');
        r.style.setProperty('--color02', 'rgba(159, 154, 174, 1)');
    }

    const status = document.getElementById("status");
    document.getElementById("statustext").textContent = '• '+msg;
    console.log(msg);
    status.classList.remove("status-hide", "status-visible");
    void status.offsetWidth;
    status.classList.add("status-visible");

    if (statusTimeout) clearTimeout(statusTimeout);

    statusTimeout = setTimeout(() => {
        status.classList.remove("status-visible");
        status.classList.add("status-hide");
    }, 6000);
}


async function updateTags(){
    for (let i=0; i<MLjson.length; i++){
        for (let e=0; e<MLjson[i].tags.length ; e++){
            MLjson[i].tags[e].checked = document.getElementById(MLjson[i].id_workshop+":"+e).checked;
        }
    }
    console.log("tags updated!")
}

async function displayMods(){
    let MLdisplay = "";
    for (let i=0; i<MLjson.length; i++){
        let MLTags = "";
        for (let e=0; e<MLjson[i].tags.length ; e++){
            MLTags +=`
                <div class="cbx">
                    <input type="checkbox" id="${MLjson[i].id_workshop+":"+e}" name="interest" value="${MLjson[i].id_workshop+":"+e}" ${MLjson[i].tags[e].checked ? "checked":""}/>
                    <label class="lbl_modcard-element" for="${MLjson[i].id_workshop+":"+e}">${MLjson[i].tags[e].type}: ${MLjson[i].tags[e].name}</label>
                 </div>
            `
        }
        MLdisplay +=`
            <div class="card_modcard">
                <img src="${MLjson[i].preview}" alt="${MLjson[i].name}" class="img_modcard" />
                <button class="btn_edittags" title="Edit tags" onclick="openTagsEditor(${i})"><svg width="10px" height="10px"><use href="#ico_left"></use></svg></button>
                <p class="lbl_modcard-title" >${MLjson[i].name}</p>
                <p class="lbl_modcard-element" >Workshop ID: ${MLjson[i].id_workshop}</p>
                <div class="card_modcard-cbx">
                    ${MLTags}
                </div>
                <div class="card_modcard_buttons">
                    <button class="btn_modcard" title="Move left" onclick="moveMod(${MLjson[i].id_workshop}, -1)"><svg width="30px" height="30px"><use href="#ico_left"></use></svg></button>
                    <button class="btn_modcard" title="Open Steam page" onclick="window.open('${MLjson[i].link}', '_blank')"><svg width="30px" height="30px"><use href="#ico_steam"></use></svg></button>
                    <button class="btn_modcard" title="Delete mod" onclick="deleteMod(${MLjson[i].id_workshop})" ><svg width="30px" height="30px"><use href="#ico_delete"></use></svg></button>
                    <button class="btn_modcard" title="Add next to this mod" onClick="addMod('addNext', ${MLjson[i].id_workshop})"><svg width="30px" height="30px"><use href="#ico_next"></use></svg></button>
                    <button class="btn_modcard" title="Move right" onclick="moveMod(${MLjson[i].id_workshop}, 1)"><svg width="30px" height="30px"><use href="#ico_right"></use></svg></button>
                </div>
            </div>
        `;

        
    }
    console.log("Mods displayed succesfully")
    document.getElementById("modlistcontent").innerHTML = MLdisplay;
    
    for (let i = 0; i < MLjson.length; i++) {
        for (let e = 0; e < MLjson[i].tags.length; e++) {
            const cb = document.getElementById(`${MLjson[i].id_workshop}:${e}`);
            if (cb) {
                cb.onchange = function () {
                    updateTags();
                    saveToLocalStorage();
                };
            }
        }
    }
    
}

async function addMod(action, actid) {
    id = "";
    if (action == 'readActID'){
        id = actid
    } else { id = document.getElementById("workshopId").value.trim(); }
    console.log("id: "+id)
    if (!/^\d+$/.test(id)) {
        setStatus("Error: Enter a valid Workshop ID.", 'b');
        return;
    } else if (MLjson.some(item => item.id_workshop === id)){
        setStatus("Error: This mod is already in the list.", 'b');
        return;
    }

    const modget = await getWorkshopDetails(id);
    if (!modget) return;
    if (modget.consumer_app_id != "108600"){
        setStatus("Error: This mod is not for Project Zomboid", 'b');
        return;
    }

    let desc = modget.description || modget.file_description || "...";
    let regex = /(mod\s*id|map\s*folder)\s*[:=]\s*([^\n\r,;]+)/gi;
    let matches = [...desc.matchAll(regex)];
    let mods = [];
    let maps = [];

    for (let match of matches) {
        let type = match[1].toLowerCase().includes("mod") ? "Mod" : "Map";
        let name = match[2].trim();

        if (type === "Mod") {
            mods.push({ 'name': name, 'type': type+' ID', 'checked' : true});
        } else {
            maps.push({ 'name': name, 'type': type+' Folder', 'checked' : true});
        }
    }
    let tags = [...mods, ...maps];

    const newEntry = {
        'id_workshop': id,
        'name': modget.title,
        'link': `https://steamcommunity.com/sharedfiles/filedetails/?id=${id}`,
        'preview' : modget.preview_url,
        'tags': tags,
    }
    if (action == 'addNext') {
        const index = MLjson.findIndex(mod => mod.id_workshop === actid.toString().trim());
        if (index !== -1) {
            MLjson.splice(index + 1, 0, newEntry);
        }
    } else { MLjson.push(newEntry); }
    
    if (action != 'readActID') { setStatus("Mod added successfuly!", 'a'); }
    
    

    updateTags();  
    displayMods();
    saveToLocalStorage();
}



async function getWorkshopDetails(idRaw){
    console.log("Consultando Steam API...");
    try {
        const body = new URLSearchParams();
        body.append("itemcount", "1");
        body.append("publishedfileids[0]", idRaw);
        
        const proxy = "https://cors-anywhere.herokuapp.com/"; // CORS Anywhere
        const url = proxy + "https://api.steampowered.com/ISteamRemoteStorage/GetPublishedFileDetails/v1/"; // Steam API - Workshop

        const res = await fetch(url, { method: "POST", body });
        const data = await res.json();
        const d = data?.response?.publishedfiledetails?.[0];
        if (!d || d.result !== 1) throw new Error("Invalid or private ID");

        
        return d;
    } catch (err) {
        console.error(err);
        setStatus("Error: " + err.message, 'b');
        onclick=window.open("https://cors-anywhere.herokuapp.com/corsdemo");

    }
}

async function getCollectionWorkshopIDs(collectionId) {
    setStatus("Consultando Steam API para la colección...",'c');
    try {
        const body = new URLSearchParams();
        body.append("collectioncount", "1");
        body.append("publishedfileids[0]", collectionId);

        const proxy = "https://cors-anywhere.herokuapp.com/";
        const url = proxy + "https://api.steampowered.com/ISteamRemoteStorage/GetCollectionDetails/v1/";

        const res = await fetch(url, { method: "POST", body });
        const data = await res.json();
        const collection = data?.response?.collectiondetails?.[0];

        if (!collection || collection.result != 1) throw new Error("Invalid or private collection ID");

        if (!Array.isArray(collection.children)) {
            setStatus("No children found in collection.", 'b');
            return [];
        }

        const workshopIDs = collection.children
            .filter(child => child.filetype == 0)
            .map(child => child.publishedfileid);

        return workshopIDs;
    } catch (err) {
        console.error(err);
        setStatus("Error: " + err.message, 'b');
        window.open("https://cors-anywhere.herokuapp.com/corsdemo");
        return [];
    }
}


function deleteMod(id) {
    console.log( id.toString() );
    const index = MLjson.findIndex(mod => mod.id_workshop === id.toString());
    if (index !== -1) {
        MLjson.splice(index, 1);
    }
    updateTags();  
    displayMods();
    saveToLocalStorage();
}

function moveMod(id, direction) {
    const index = MLjson.findIndex(mod => mod.id_workshop === id.toString());
    if (index === -1) return;

    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= MLjson.length) return;

    const [mod] = MLjson.splice(index, 1);
    MLjson.splice(newIndex, 0, mod);

    updateTags();  
    displayMods();
    saveToLocalStorage();
}


function importJson() {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".json";
    input.style.display = "none";


    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);

    input.onchange = () => {
        const archivo = input.files[0];
        if (!archivo) return;
        const lector = new FileReader();
        lector.onload = (e) => {
            try {
                MLjson = JSON.parse(e.target.result);
                console.log("Loading Json:", MLjson);
                saveToLocalStorage();
                displayMods();
            } catch (err) {
            setStatus("Error parsing Json:"+ err, 'b');
                return;
            }
        };
        lector.readAsText(archivo);
        setStatus("Json loaded successfuly!", 'a')
    };

}

function exportJson() {
    updateTags();
    const jsonString = JSON.stringify(MLjson, null, 2);
    const blob = new Blob([jsonString], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Project Zomboid Modlist.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    setStatus("Json exported successfuly!", 'a');
}

function copyWorkshopID() {
    clipboard = "";
    for (let i=0; i<MLjson.length; i++){
        clipboard += MLjson[i].id_workshop + "; ";
    }
    navigator.clipboard.writeText(clipboard);
    setStatus("Workshop IDs copied to clipboard", 'a')
}

function copyModID() {
    clipboard = "";
    for (let i=0; i<MLjson.length; i++){
        for (let e=0; e<MLjson[i].tags.length ; e++){
            if (MLjson[i].tags[e].type === "Mod ID" && MLjson[i].tags[e].checked){
                clipboard += MLjson[i].tags[e].name + "; ";
            }
        }
    }
    navigator.clipboard.writeText(clipboard);
    setStatus("Mod IDs copied to clipboard", 'a')
}

function copyMapID() {
    clipboard = "";
    for (let i=0; i<MLjson.length; i++){
        for (let e=0; e<MLjson[i].tags.length ; e++){
            if (MLjson[i].tags[e].type === "Map Folder" && MLjson[i].tags[e].checked){
                clipboard += MLjson[i].tags[e].name + "; ";
            }
        }
    }
    navigator.clipboard.writeText(clipboard);
    setStatus("Map Folders copied to clipboard", 'a')
}

function clearAll(warn) {
    if (warn){
        ask = confirm("Are you sure you want to clear the entire modlist? This action cannot be undone.")
    } else { ask = true }
    if (ask) {
        MLjson = [];
        displayMods();
        saveToLocalStorage();
        setStatus("Mod list cleared!", 'a');
    }
}

async function importCollection() {
    document.getElementById('overlay_Collection').hidden = true;
    const id = document.getElementById("collectionId").value.trim();
    if (!/^\d+$/.test(id)) {
        setStatus("Error: Enter a valid Collection ID.", 'b');
        return;
    }
    if (MLjson.length > 0){
        ask = confirm("Importing a collection will override your current modlist. Are you sure you want to continue? This action cannot be undone.")
        if (ask){ clearAll(); } else { return; }
    }
    const idlist = await getCollectionWorkshopIDs(parseInt(id));
    if (!idlist){return;}
    setStatus("Loading collection... Wait until it's finished",'c')
    for (let i=0; i<idlist.length; i++){
        await addMod('readActID',idlist[i])
    }
    setStatus("Collection loaded succesfully!",'a')
    saveToLocalStorage();
}




function openTagsEditor(index) {
    currentEditIndex = index;
    tempTags = MLjson[index].tags.map(tag => ({...tag}));
    displayTagEditor();
    document.getElementById('overlay_TagEditor').hidden = false;
}

function displayTagEditor() {
    let TDisplay = "";
    for (let i = 0; i < tempTags.length; i++) {
        TDisplay += `
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                <div class="cbx">
                    <input type="checkbox" id="tag-cb-${i}" ${tempTags[i].checked ? "checked" : ""} />
                    <label for="tag-cb-${i}"></label>
                </div>
                <select class="dropdown" id="tag-type-${i}">
                    <option class="dropdown_opt" value="Mod ID" ${tempTags[i].type === "Mod ID" ? "selected" : ""}>Mod ID</option>
                    <option class="dropdown_opt" value="Map Folder" ${tempTags[i].type === "Map Folder" ? "selected" : ""}>Map Folder</option>
                </select>
                <input type="text" class="txt_tagseditor" id="tag-name-${i}" value="${tempTags[i].name.replace(/"/g, "&quot;")}" />
                <button class="btn_modcard" type="button" onclick="removeTagEditorTag(${i})"><svg width="20px" height="20px"><use href="#ico_delete"></use></svg></button>
            </div>
        `;
    }
    document.getElementById('tagEditorList').innerHTML = TDisplay;

    for (let i = 0; i < tempTags.length; i++) {
        document.getElementById(`tag-cb-${i}`).onchange = function() {
            tempTags[i].checked = this.checked;
        };
        document.getElementById(`tag-type-${i}`).onchange = function() {
            tempTags[i].type = this.value;
        };
        document.getElementById(`tag-name-${i}`).oninput = function() {
            tempTags[i].name = this.value;
        };
    }
}

function removeTagEditorTag(idx) {
    tempTags.splice(idx, 1);
    displayTagEditor();
}

document.getElementById('addTagBtn').onclick = function() {
    tempTags.push({checked: true, type: 'Mod ID', name: ''});
    displayTagEditor();
};

document.getElementById('doneTagEditBtn').onclick = function() {
    if (currentEditIndex !== null) {
        MLjson[currentEditIndex].tags = tempTags.map(tag => ({...tag}));
        displayMods();
        saveToLocalStorage();
        setStatus("Tags updated!", 'a');
    }
    document.getElementById('overlay_TagEditor').hidden = true;
};



function loadFromLocalStorage() {
    const saved = localStorage.getItem("modlist");
    if (saved) {
        try {
            MLjson = JSON.parse(saved);
            displayMods();
        } catch (err) {
            setStatus("Error loading saved modlist:"+ err, 'b');
        }
    }
}

function saveToLocalStorage() {
    localStorage.setItem("modlist", JSON.stringify(MLjson));
    console.log("Saved to local storage")
}

document.addEventListener("DOMContentLoaded", () => {
    loadFromLocalStorage();
});
</script>
</body>

</html>